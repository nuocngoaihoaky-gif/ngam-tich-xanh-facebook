name: Production_Infrastructure_Monitor

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  system-check:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      # ================== [NEW] CHECK IP BOYDTON (Y H·ªÜT L√öC N√ÉY) ==================
      - name: Check runner IP location (Boydton only)
        run: |
          echo "=== üåç CHECKING RUNNER IP (BOYDTON REQUIRED) ==="
          IP_INFO=$(curl -s https://ipinfo.io/json)
          echo "$IP_INFO"

          CITY=$(echo "$IP_INFO" | jq -r '.city')
          REGION=$(echo "$IP_INFO" | jq -r '.region')
          COUNTRY=$(echo "$IP_INFO" | jq -r '.country')

          echo "City    : $CITY"
          echo "Region  : $REGION"
          echo "Country : $COUNTRY"

          if [[ "$CITY" != "Boydton" || "$REGION" != "Virginia" || "$COUNTRY" != "US" ]]; then
            echo "‚ùå IP KH√îNG PH·∫¢I Boydton, Virginia, US ‚Üí D·ª™NG JOB"
            exit 1
          fi

          echo "‚úÖ IP ƒê√öNG Boydton, Virginia, US ‚Üí TI·∫æP T·ª§C"

      # ================== LOGIC C≈® ‚Äì GI·ªÆ NGUY√äN ==================
      - name: Check Concurrent Runs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo ">>> üïµÔ∏è ƒêang ki·ªÉm tra xem c√≥ Bot n√†o ƒëang ch·∫°y kh√¥ng..."
          
          running_jobs=$(gh run list --repo ${{ github.repository }} \
            --workflow "Production_Infrastructure_Monitor" \
            --status in_progress \
            --json databaseId \
            --jq ".[] | select(.databaseId != ${{ github.run_id }}) | .databaseId")
          
          if [ -n "$running_jobs" ]; then
            echo ">>> ‚ö†Ô∏è PH√ÅT HI·ªÜN BOT C≈® ƒêANG CH·∫†Y (IDs: $running_jobs)"
            echo ">>> üõë Bot m·ªõi s·∫Ω t·ª± h·ªßy ƒë·ªÉ kh√¥ng l√†m phi·ªÅn Bot c≈©..."
            gh run cancel ${{ github.run_id }}
            sleep 30
          else
            echo ">>> ‚úÖ Kh√¥ng c√≥ ai ƒëang ch·∫°y c·∫£. S√¢n kh·∫•u n√†y l√† c·ªßa t√¥i!"
          fi

      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install selenium requests pytz undetected-chromedriver

      - name: Execute Diagnostics
        env:
          FB_EMAIL: ${{ secrets.FB_EMAIL }}
          FB_PASS: ${{ secrets.FB_PASS }}
          GAS_API_URL: ${{ secrets.GAS_API_URL }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        timeout-minutes: 365 
        run: python -u main.py

      - name: Upload Error Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: "*.png"
