name: Production_Infrastructure_Monitor

on:
  schedule:
    # 1. TƒÇNG T·∫¶N SU·∫§T: Ch·∫°y m·ªói 30 ph√∫t
    # ƒê·ªÉ ƒë·∫£m b·∫£o ngay khi ca c≈© 6h k·∫øt th√∫c, ca m·ªõi s·∫Ω n·ªëi ƒëu√¥i ngay.
    - cron: '*/30 * * * *'
  
  # Cho ph√©p b·∫•m ch·∫°y tay
  workflow_dispatch:

jobs:
  system-check:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
      # 2. CHI·∫æN THU·∫¨T "K√çNH L√ÉO ƒê·∫ÆC TH·ªå" (Skip if Running)
      - name: Check Concurrent Runs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo ">>> üïµÔ∏è ƒêang ki·ªÉm tra xem c√≥ Bot n√†o ƒëang ch·∫°y kh√¥ng..."
          
          # L·∫•y danh s√°ch c√°c run ƒëang ch·∫°y (in_progress) tr·ª´ ch√≠nh n√≥ ra
          running_jobs=$(gh run list --repo ${{ github.repository }} \
            --workflow "Production_Infrastructure_Monitor" \
            --status in_progress \
            --json databaseId \
            --jq ".[] | select(.databaseId != ${{ github.run_id }}) | .databaseId")
          
          if [ -n "$running_jobs" ]; then
            echo ">>> ‚ö†Ô∏è PH√ÅT HI·ªÜN BOT C≈® ƒêANG CH·∫†Y (IDs: $running_jobs)"
            echo ">>> üõë Bot m·ªõi s·∫Ω t·ª± h·ªßy ƒë·ªÉ kh√¥ng l√†m phi·ªÅn Bot c≈©..."
            gh run cancel ${{ github.run_id }}
            sleep 30 # ƒê·ª£i l·ªánh h·ªßy c√≥ hi·ªáu l·ª±c
          else
            echo ">>> ‚úÖ Kh√¥ng c√≥ ai ƒëang ch·∫°y c·∫£. S√¢n kh·∫•u n√†y l√† c·ªßa t√¥i!"
          fi

      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 3. C√ÄI ƒê·∫∂T
      - name: Install Dependencies
        run: |
          pip install selenium requests pytz undetected-chromedriver

      # 4. CH·∫†Y BOT (Timeout 365p ~ 6h5p ƒë·ªÉ tr·ª´ hao)
      - name: Execute Diagnostics
        env:
          FB_EMAIL: ${{ secrets.FB_EMAIL }}
          FB_PASS: ${{ secrets.FB_PASS }}
          GAS_API_URL: ${{ secrets.GAS_API_URL }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        timeout-minutes: 365 
        run: python -u main.py

      # 5. CH·ª§P ·∫¢NH L·ªñI (N·∫øu c·∫ßn debug)
      - name: Upload Error Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: "*.png"
