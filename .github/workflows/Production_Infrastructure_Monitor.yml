name: Production_Infrastructure_Monitor

on:
  workflow_dispatch:

jobs:
  system-check:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      # ================== CHECK CONCURRENT RUNS (∆ØU TI√äN TR∆Ø·ªöC) ==================
      - name: Check Concurrent Runs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo ">>> üïµÔ∏è ƒêang ki·ªÉm tra xem c√≥ Bot n√†o ƒëang ch·∫°y kh√¥ng..."
          
          running_jobs=$(gh run list --repo ${{ github.repository }} \
            --workflow "Production_Infrastructure_Monitor" \
            --status in_progress \
            --json databaseId \
            --jq ".[] | select(.databaseId != ${{ github.run_id }}) | .databaseId")
          
          if [ -n "$running_jobs" ]; then
            echo ">>> ‚ö†Ô∏è PH√ÅT HI·ªÜN BOT KH√ÅC ƒêANG CH·∫†Y (IDs: $running_jobs)"
            echo ">>> üõë Run hi·ªán t·∫°i s·∫Ω t·ª± d·ª´ng ngay, kh√¥ng check IP n·ªØa"
            gh run cancel ${{ github.run_id }}
            sleep 10
            exit 0
          else
            echo ">>> ‚úÖ Kh√¥ng c√≥ ai ƒëang ch·∫°y c·∫£. Ti·∫øp t·ª•c workflow."
          fi

      # ================== CHECK IP BOYDTON ==================
      - name: Check runner IP location (Boydton only)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== üåç CHECKING RUNNER IP (BOYDTON REQUIRED) ==="
          IP_INFO=$(curl -s https://ipinfo.io/json)
          echo "$IP_INFO"

          CITY=$(echo "$IP_INFO" | jq -r '.city')
          REGION=$(echo "$IP_INFO" | jq -r '.region')
          COUNTRY=$(echo "$IP_INFO" | jq -r '.country')

          echo "City    : $CITY"
          echo "Region  : $REGION"
          echo "Country : $COUNTRY"

          if [[ "$CITY" != "Boydton" || "$REGION" != "Virginia" || "$COUNTRY" != "US" ]]; then
            echo "‚ùå IP KH√îNG PH·∫¢I Boydton, Virginia, US"

            echo "üöÄ G·ªåI L·∫†I CH√çNH WORKFLOW N√ÄY (RUN M·ªöI HO√ÄN TO√ÄN)..."

            curl -s -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/Production_Infrastructure_Monitor.yml/dispatches \
              -d '{
                "ref": "main"
              }'

            echo "üõë D·ª™NG RUN HI·ªÜN T·∫†I"
            exit 1
          fi

          echo "‚úÖ IP ƒê√öNG Boydton, Virginia, US ‚Üí TI·∫æP T·ª§C"

      # ================== LOGIC C≈® ‚Äì GI·ªÆ NGUY√äN ==================
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install selenium requests pytz undetected-chromedriver

      # ================== CH·ªñ QUAN TR·ªåNG ƒê√É S·ª¨A ==================
      - name: Execute Diagnostics
        env:
          FB_EMAIL: ${{ secrets.FB_EMAIL }}
          FB_PASS: ${{ secrets.FB_PASS }}
          GAS_API_URL: ${{ secrets.GAS_API_URL }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

          # ===== TH√äM ƒê·ªÇ PYTHON G·ªåI ƒê∆Ø·ª¢C GITHUB API =====
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}

        timeout-minutes: 365
        run: python -u main.py

      - name: Upload Error Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: "*.png"
